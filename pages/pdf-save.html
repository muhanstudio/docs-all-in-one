<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PDF Viewer</title>
  <style>
    #pdfContainer {
      position: relative;
      width: 100%;
      height: 100vh;
    }

    #pdfViewer canvas {
      display: block;
    }
  </style>
  <script src="../static/pdf.js"></script>
</head>
<body>
  <input type="file" accept=".pdf" id="pdfFileInput">
  <div id="pdfContainer">
    <button id="prevPageButton">上一页</button>
    <button id="nextPageButton">下一页</button>
    <div id="pdfViewer"></div>
  </div>

  <script>
    var pdfDoc = null;
    var pageNum = 1;
    var scale = 1.5;

    document.getElementById('pdfFileInput').addEventListener('change', function(e) {
      var file = e.target.files[0];
      var reader = new FileReader();

      reader.onload = function() {
        var typedarray = new Uint8Array(this.result);
        displayPDF(typedarray);
      };

      reader.readAsArrayBuffer(file);
    });

    function displayPDF(data) {
      pdfjsLib.getDocument(data).promise.then(function(pdf) {
        pdfDoc = pdf;
        renderPage(pageNum);
        setTimeout(function() {
          generateSnapshot();
        }, 2000); // 延迟1秒调用generateSnapshot()
      });
    }

    function renderPage(num) {
      pdfDoc.getPage(num).then(function(page) {
        var pdfCanvas = document.createElement('canvas');
        var context = pdfCanvas.getContext('2d');
        var viewport = page.getViewport({ scale: scale });

        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;

        var renderContext = {
          canvasContext: context,
          viewport: viewport
        };

        page.render(renderContext).promise.then(function() {
          var container = document.getElementById('pdfViewer');
          container.innerHTML = '';
          container.appendChild(pdfCanvas);
        });
      });
    }

    document.getElementById('prevPageButton').addEventListener('click', function() {
      if (pageNum > 1) {
        pageNum--;
        renderPage(pageNum);
        setTimeout(function() {
          generateSnapshot();
        }, 500); // 延迟1秒调用generateSnapshot()
      }
    });

    document.getElementById('nextPageButton').addEventListener('click', function() {
      if (pageNum < pdfDoc.numPages) {
        pageNum++;
        renderPage(pageNum);
        setTimeout(function() {
          generateSnapshot();
        }, 500); // 延迟1秒调用generateSnapshot()
      }
    });
    function generateSnapshot() {
      var container = document.getElementById('pdfViewer');
      var pdfCanvas = container.querySelector('canvas');
      var snapshotDataURL = pdfCanvas.toDataURL('image/png');

      // 创建一个空的HTML模板
      var htmlTemplate = `<!DOCTYPE html>
        <html>
        <head>
          <title>PDF Snapshot</title>
        </head>
        <body>
          <img src="${snapshotDataURL}" alt="PDF Snapshot">
        </body>
        </html>`;

      var id = window.frameElement.parentElement.parentElement.getAttribute("data-node-id");
      var fileName = id + '.html';

      var formData = new FormData();
      formData.append('assetsDirPath', 'widgets/docs-all-in-one/data');
      formData.append('file[]', new Blob([htmlTemplate], { type: 'text/html' }), fileName);

      fetch('/api/asset/upload', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          var succMap = data.data.succMap;
          if (succMap && succMap[fileName]) {
            var snapshotUrl = succMap[fileName];
            console.log('Snapshot uploaded successfully:', snapshotUrl);
          } else {
            console.error('Failed to upload snapshot');
          }
        })
        .catch(error => {
          console.error('Error uploading snapshot:', error);
        });
    }
  </script>
</body>
</html>